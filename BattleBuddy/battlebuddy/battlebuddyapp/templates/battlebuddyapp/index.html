<!DOCTYPE html>
<html lang="en">

<head>


	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Battle Buddy!</title>
	<!-- battlebuddy\battlebuddyapp\templates\battlebuddyapp\base.css
	battlebuddy\battlebuddyapp\templates\battlebuddyapp\index.html -->
	<!-- {%load static%} -->
	{% load static %}
	<link rel="stylesheet" type="text/css" href="{%static 'battlebuddyapp/style.css' %}" />
	<style>

	</style>
</head>

<body>

	<div id="app">

		<div class="basepannel">
			<header>
				<h1>Battle Buddy</h1>
			</header>


			<div v-if="battleopencheck == false" class="battlebox">
				<header class="title">
					<h3>Choose your battle</h3>
				</header>
				<div class="up">
					<button v-on:click="previousPage(battle)">previous</button>
				</div>

				<div class="wherebuttonsgo">
					<div>
						<button class="battlenamebutton" v-on:click="openBattle(vBattle)"
							v-for="(vBattle, index) in battles">[[vBattle.name]]</button>
					</div>
				</div>
				<div class="down">
					<button class="battlenamebutton" v-on:click="nextPage(battle)">next</button>
				</div>
			</div>
			<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ phase one end ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
			<div v-if="battleopencheck && sorted == false" class="order">



				<div class="title">[[battleName]]</div>

				<div class="sortbox">
					<div class="card" v-for=" participant in selectedBattle.participants">

						<div>[[participant.name]]</div>
						<div class="cardscore">
							<input v-model="participant.initiative" id="initiative" type="number" />
						</div>
						<div class="dice">
							<button v-on:click.stop.prevent="rollInitiative(participant)">roll Initiative</button>
						</div>
					</div>
					<button class="sb" v-if="sorted==false && battleopencheck"
						v-on:click.stop.prevent="sortParticipantsByInitiative">Sort
						partcipants</button>
				</div>
			</div>

		</div>
		<!-- ~~~~~~~~~~~~~~~~~~~~end phase two~~~~~ grid transistion~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

	

			<div v-if="sorted" class="turnbox" >
				<div class="card" v-for="participant in selectedBattle.participants">
					<div> [[participant.name]]</div>
					<div>Current Health [[participant.health]]</div>
				</div>
			</div>
			<!-- VVVVVVVV        end of p3       VVVVVVVVV -->
		</div>
	</div>
</body>

<input v-model="participant.hpchange" id="health" type="number" />

<button v-on:click.stop.prevent="changeHealth(participant)">Change HP</button>
<button v-on:click.stop.prevent="viewStats(participant)"> view stats </button>
</div>


</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.18/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script>

	let app = new Vue({
		// query selector of the html element representing the app
		el: '#app',
		delimiters: ['[[', ']]'],

		data: {

			battles: [],
			chosenone: {
				name: "",
				armor_class: 0,
				hit_points: 0,
				xp: 0,
				damage_vulnerabilities: [],
				damage_resistances: [],
				damage_immunities: [],
				condition_immunities: [],
				attack_methods: '',
				special_abilities: "",
				notes: '',
				boons: [],
				afflictions: [],
			},

			turnordercheck: false,
			agentcheck: false,
			factions: [],
			battleopencheck: false,
			search: '',
			page: 1,
			total_pages: 10,
			selectedBattle: {
				participants: []
			},
			statscan: false,

			species: {},
			hpchange: 0,
			turnorder: [],
			chosenone: {},
			selectAffliction: {},
			round: 0,
			turn: 0,
			turnindex: 0,
			sorted: false,
		},

		methods: {


			// 	trackRound: function () {
			// 		this.round += 1
			// 	},
			// 	trackTurn: function () {

			// 		this.turnindex = partcipants[(turnindex + 1) % selectedBattle.participants.length]
			// 		console.log(turnindex)
			// 	},
			viewAffliction: function (affliction) {
				this.selectAffliction = affliction
			},
			viewStats: function (participant) {
				this.statscan = true
				this.chosenone = participant
			},


			rollInitiative: function (participant) {
				let roll = (Math.floor(Math.random() * 20) + 1)

				participant.initiative = roll + participant.statblock.initiative_bonus

			},

			sortParticipantsByInitiative: function () {

				this.selectedBattle.participants.sort(function (b, a) {
					return a.initiative - b.initiative

				})
				this.sorted = true

			},

			changeHealth: function (participant) {
				let currentIndex = this.selectedBattle.participants.indexOf(participant);

				this.selectedBattle.participants[currentIndex].health = parseInt(this.selectedBattle.participants[currentIndex].health) + parseInt(this.selectedBattle.participants[currentIndex].hpchange)
				this.hpchange = 0

			},


			firstPage: function () {
				this.page = 1
				this.loadBattles()
			},



			previousPage: function () {
				if (this.page > 1) {
					this.page -= 1
					this.loadBattles()
				}
			},
			nextPage: function () {
				if (this.page < this.total_pages) {
					this.page += 1
					this.loadBattles()
				}
			},
			lastPage: function () {
				this.page = this.total_pages
				this.loadBattles()
			},


			openBattle: function (vBattle) {
				this.battleopencheck = true
				this.selectedBattle = vBattle
				this.battleName = vBattle.name


			},
			openStats: function (participant) {
				this.statblock = participant.statblock
				this.statscan = true
			},


			loadBattles: function () {
				axios({
					method: 'get',
					url: '{% url "battlebuddyapp:getbattles" %}',
					params: {
						search: this.search,
						page: this.page,
						limit: 3
					}

				}).then(response => {
					// console.log(response.data.battles)
					let data = response.data
					this.battles = data.battles
					// console.log(this.participants)
					this.total_pages = response.data.total_pages


					// this.battle = response.data.battles
				})
			},


			saveBattle: function () {
				console.log("hello world")
				axios({
					method: 'post',
					url: '{% url "battlebuddyapp:savebattle" %}',
					data: this.selectedBattle,
					headers: {
						'X-CSRFToken': '{{ csrf_token }}'
					}
				}).then(response => {
					// console.log(response.data)
				})
			}
		},

		created: function () {

			this.loadBattles()

		}
	})
</script>
</body>

</html>